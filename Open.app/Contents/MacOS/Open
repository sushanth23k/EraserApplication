#!/usr/bin/env bash
set -euo pipefail

# Ensure common paths so node/python are found when launched from Finder
export PATH="/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:$PATH"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
APP_CONTENTS="$(dirname "$SCRIPT_DIR")"
PROJECT_ROOT="$(cd "$APP_CONTENTS/.." && pwd)"

# Set icon from frontend/public/open.png if available
ICON_SRC="$PROJECT_ROOT/frontend/public/open.png"
ICON_DEST="$APP_CONTENTS/Resources/Open.icns"
mkdir -p "$APP_CONTENTS/Resources"
if [[ -f "$ICON_SRC" ]]; then
  TMP_ICONSET=$(mktemp -d)
  if command -v sips >/dev/null 2>&1 && command -v iconutil >/dev/null 2>&1; then
    cp "$ICON_SRC" "$TMP_ICONSET/icon_512x512.png"
    sips -z 16 16     "$TMP_ICONSET/icon_512x512.png" --out "$TMP_ICONSET/icon_16x16.png" >/dev/null 2>&1 || true
    sips -z 32 32     "$TMP_ICONSET/icon_512x512.png" --out "$TMP_ICONSET/icon_16x16@2x.png" >/dev/null 2>&1 || true
    sips -z 32 32     "$TMP_ICONSET/icon_512x512.png" --out "$TMP_ICONSET/icon_32x32.png" >/dev/null 2>&1 || true
    sips -z 64 64     "$TMP_ICONSET/icon_512x512.png" --out "$TMP_ICONSET/icon_32x32@2x.png" >/dev/null 2>&1 || true
    sips -z 128 128   "$TMP_ICONSET/icon_512x512.png" --out "$TMP_ICONSET/icon_128x128.png" >/dev/null 2>&1 || true
    sips -z 256 256   "$TMP_ICONSET/icon_512x512.png" --out "$TMP_ICONSET/icon_128x128@2x.png" >/dev/null 2>&1 || true
    sips -z 256 256   "$TMP_ICONSET/icon_512x512.png" --out "$TMP_ICONSET/icon_256x256.png" >/dev/null 2>&1 || true
    cp "$TMP_ICONSET/icon_512x512.png" "$TMP_ICONSET/icon_256x256@2x.png"
    iconutil -c icns "$TMP_ICONSET" -o "$ICON_DEST" >/dev/null 2>&1 || true
    rm -rf "$TMP_ICONSET"
  fi
fi

osascript -e 'display dialog "Start backend and frontend now?" buttons {"Cancel","Start"} default button "Start" with title "Eraser"' || exit 1

# Delegate to helper script to avoid path issues
if [[ -f "$APP_CONTENTS/Script/open.sh" ]]; then
  bash "$APP_CONTENTS/Script/open.sh" || { osascript -e "display alert \"Failed to start services\""; exit 1; }
else
  osascript -e "display alert \"Open helper not found\" message \"Script/open_helper.sh missing\""
  exit 1
fi

osascript -e 'display notification "Servers started" with title "Eraser" subtitle "Frontend 3000, Backend 5001"'


