#!/usr/bin/env bash
set -euo pipefail

# Ensure common paths so node/python are found when launched from Finder
export PATH="/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:$PATH"

# Determine project root (from Contents/MacOS go two levels up)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
APP_CONTENTS="$(dirname "$SCRIPT_DIR")"
PROJECT_ROOT="$(cd "$APP_CONTENTS/../.." && pwd)"

# Set icon from frontend/public/Setup.png if available (best-effort; icon should also be prebuilt)
ICON_SRC="$PROJECT_ROOT/frontend/public/Setup.png"
ICON_DEST="$APP_CONTENTS/Resources/Setup.icns"
mkdir -p "$APP_CONTENTS/Resources"
if [[ -f "$ICON_SRC" ]]; then
  # Try to convert PNG to ICNS if sips/iconutil available
  TMP_ICONSET=$(mktemp -d)
  if command -v sips >/dev/null 2>&1 && command -v iconutil >/dev/null 2>&1; then
    cp "$ICON_SRC" "$TMP_ICONSET/icon_512x512.png"
    sips -z 16 16     "$TMP_ICONSET/icon_512x512.png" --out "$TMP_ICONSET/icon_16x16.png" >/dev/null 2>&1 || true
    sips -z 32 32     "$TMP_ICONSET/icon_512x512.png" --out "$TMP_ICONSET/icon_16x16@2x.png" >/dev/null 2>&1 || true
    sips -z 32 32     "$TMP_ICONSET/icon_512x512.png" --out "$TMP_ICONSET/icon_32x32.png" >/dev/null 2>&1 || true
    sips -z 64 64     "$TMP_ICONSET/icon_512x512.png" --out "$TMP_ICONSET/icon_32x32@2x.png" >/dev/null 2>&1 || true
    sips -z 128 128   "$TMP_ICONSET/icon_512x512.png" --out "$TMP_ICONSET/icon_128x128.png" >/dev/null 2>&1 || true
    sips -z 256 256   "$TMP_ICONSET/icon_512x512.png" --out "$TMP_ICONSET/icon_128x128@2x.png" >/dev/null 2>&1 || true
    sips -z 256 256   "$TMP_ICONSET/icon_512x512.png" --out "$TMP_ICONSET/icon_256x256.png" >/dev/null 2>&1 || true
    cp "$TMP_ICONSET/icon_512x512.png" "$TMP_ICONSET/icon_256x256@2x.png"
    iconutil -c icns "$TMP_ICONSET" -o "$ICON_DEST" >/dev/null 2>&1 || true
    rm -rf "$TMP_ICONSET"
  fi
fi

osascript -e 'display notification "Installing dependencies..." with title "Eraser Setup" subtitle "This may take a few minutes"'

# Delegate to a helper script in repo to avoid path confusion
if [[ -f "$APP_CONTENTS/scripts/setup_helper.sh" ]]; then
  bash "$APP_CONTENTS/scripts/setup_helper.sh" || {
    osascript -e "display alert \"Setup failed\" message \"See console logs\""; exit 1; }
else
  osascript -e "display alert \"Setup helper not found\" message \"scripts/setup_helper.sh missing\""
  exit 1
fi

osascript -e 'display notification "Setup completed" with title "Eraser Setup"'


